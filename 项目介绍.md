## 项目介绍

本项目是一个基于 WinForms + OpenTK 的点云查看与处理工具，支持在 2D 模式下手动选择范围获取大楼点云数据，自动解析建筑四个立面并生成规则化立面点集，按“蛇形路径”对每个面进行排序，最终导出 QGC WPL 110 航点文件。

### 核心能力
- **2D多边形范围选择**: 在 XY 平面中交互式圈选多边形，过滤出选区内的原始点云。
- **大楼立面优化与生成**: 使用鲁棒 PCA 估计建筑主方向，并以凸包“外轮廓挤出”的方式生成四个立面的规则化点集。
- **立面排序与航点导出**: 按“自上而下 + 蛇形”策略排序每个面的点，并批量导出 QGC WPL 110 航点文件（每面一个文件）。

### 关键文件
- `PCDViewer_New.cs`：UI 入口、数据加载、启动范围选择、触发立面分析与导出。
- `RangeSelectionWindow.cs`：2D 多边形选区窗口（XY 平面），输出世界坐标的多边形顶点。
- `Filtering/PointCloudFilter.cs`：多边形点内判定、过滤与结果保存。
- `Analysis/FacadeManager.cs`：立面识别、规则点生成、排序与航点导出。
- `Core/CoordinateMapper.cs`：坐标系映射（适配外部坐标/飞控要求）。


## 使用流程

### 1. 加载点云
- 启动应用后在菜单“文件-打开”选择点云（支持 PLY、CloudCompare ASCII）。
- 如需调整坐标系，可使用键盘 `1~8` 或 `C` 循环选择映射，常用映射已在 `CoordinateMapper` 中预置。

### 2. 切换到 2D 模式手动选择范围
- 菜单“工具-选择范围”或 `Ctrl+R` 打开 2D 选区窗口。
- 交互：
  - 左键添加顶点；拖拽移动已有顶点；右键/Enter 完成；ESC 取消；Delete 删除最后一个点。
  - 中键平移，滚轮缩放（0.1x~10x）。
- `RangeSelectionWindow` 内部始终以“世界 XY 坐标”保存与返回多边形，避免屏幕缩放/平移误差。

### 3. 过滤出大楼点云并保存
- 选择完成后触发 `PointCloudFilter.FilterPointsInPolygon`（射线法），仅保留 XY 在多边形内部的点。
- `PointCloudFilter.ApplyFilteredPoints` 将过滤结果应用到当前数据并重置相机。
- 过滤结果会另存为 PLY 文件：`filtered_points_yyyyMMdd_HHmmss.ply`（位于原数据目录）。
- 再次应用当前的坐标映射，保证渲染状态与后续分析一致。


## 大楼数据优化与四面生成（立面识别）

立面分析在首次进入立面模式时触发（例如按 F1~F4 显示/隐藏某面，或 F6 在“规律/原始”立面间切换），也会在首次显示“生成立面”（G）时自动执行。

### 分析步骤（`FacadeManager.AnalyzeFacades`）
1) **鲁棒 PCA（XY）估计主方向**
   - 对全部点按到中心半径排序，保留 95% 内点以抑制离群点。
   - 计算 XY 协方差矩阵并求最大特征向量为主方向，法向为副方向；记录真实方位角并转换为指南针文字（如“朝向南东南”）。
2) **外轮廓挤出生成规则点**
   - `ComputeConvexHull2D` 计算 XY 凸包（单调链），按顺时针返回以获得一致的外法线方向。
   - 沿凸包每条边均匀采样（默认 `pointSpacing = 8f`），在 Z 方向分层挤出（默认 `zSpacing = 4f`，层数自适应）。
   - `AssignEdgeSamplesToFacade` 将边采样点按外法线与四个候选方向（主±、垂直±）夹角最小的规则分配到对应立面。
3) **方位信息与一致性检查**
   - `UpdateFacadeAzimuthInfo` 设置每面的真实方位角与中文名（含朝向）。
   - `VerifyFacadeConsistency` 输出每面原始/生成点数、方位等日志，便于核查。

### 参数说明
- 规则点生成：`pointSpacing = 8f`（沿边采样间距）、`zSpacing = 4f`（层间距）。
- 可见性控制：F1~F4 切换四个面，F5 显示全部，G 切换“生成立面”显示，F6 在“规律/原始”立面色彩间切换。


## 每个面的排序与航点导出

### 排序策略（蛇形路径，`GetSnakeOrderedPoints`）
- 按 Z 值从高到低分层，层内 Z 差小于 `layerMergeEpsilon`（默认 0.6f）合并为同层。
- 沿该面的水平走向排序：
  - 主方向的两个面按“副方向向量”排序；
  - 垂直方向的两个面按“主方向向量”排序。
- 奇偶层交替反转，形成连续“蛇形”路径，减少升降/转向成本。

### 航点导出（`ExportFacadesToQgc(basePath, layerMergeEpsilon)`）
- 每个面生成一个 `QGC WPL 110` 文件，文件名包含中文面名与朝向，例如：
  - `facades_主方向正面 (朝向南东南).waypoints`
- 字段顺序：`seq current frame command p1 p2 p3 p4 lat lon alt autocontinue`。
- 触发方式：
  - 首次按 `G` 显示“生成立面”时，会自动在程序目录下导出 `facades_*.waypoints`；
  - 或在代码中调用 `ExportFacadesToQgc` 并指定 `basePath`。

### 重要注意（经/纬/高的字段映射）
- 代码注释声明使用 `X→lat, Y→lon, Z→alt`，但当前实现把 `lon` 写成了 `Z`，`alt` 也写成了 `Z`。建议修正为：
  - `lat = X`，`lon = Y`，`alt = Z`。
- QGC 的 `MAV_FRAME_GLOBAL` 语义是地理坐标（单位：度/米）。若点云坐标系为工程局部坐标，仅用于仿真可视化；用于真实飞控前需进行“工程坐标→WGS84”的比例/旋转/平移拟合，或改用本地坐标系（如 `LOCAL_NED`）并按需更换导出格式/下发方式。


## 快捷键（节选）
- **范围选择**：`Ctrl+R`
- **坐标映射**：`1~8` 或 `C` 循环
- **立面显示**：`F1~F4` 切换四面，`F5` 显示全部
- **立面模式**：`F6` 规律/原始 切换
- **生成立面显示**：`G`
- **点大小**：`+/-/0` 或 `F10/F11/F12`


## 实施建议与可扩展点
- 将 `pointSpacing`、`zSpacing`、`layerMergeEpsilon` 做成 UI 可配置，便于按机型/相机/楼体快速调优。
- 在导出航点前，增加交互式“面别名/顺序/起止层/下采样密度”配置，适配不同作业策略。
- 若有地理参考，提供“工程坐标→WGS84（经纬高）”拟合工具并支持高程基准选择。
- 对“生成立面点”增加去重/平滑/栅格化，减少冗余点，利于航线稀疏化与飞控执行。


## 常见问题（FAQ）
- **选区为何以 XY 为准？** 立面分析和凸包外轮廓均在 XY 平面完成，保持一致可降低复杂度并提高稳定性。
- **点云坐标方向不对导致选区异常？** 先用 `1~8` 或 `C` 切换到合适的坐标映射，再进行 2D 选区。
- **导出的航点能直接飞吗？** 若未做坐标拟合，仅适合仿真/可视化。实飞前需确保 `lat/lon/alt` 与飞控坐标框架一致。


