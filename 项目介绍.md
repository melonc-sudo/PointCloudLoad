本文以“思考流程”为中心，简要说明三步法：
1) 将点云转换为 2D 并用选区得到大楼点云；
2) 在 2D 上获取边界范围并分割出大楼四个面；
3) 按指定距离优化每个面的点云，蛇形排序后生成航点文件。


一、将点云数据 2D 化 + 选区过滤

1) 2D 转换（XY 投影 + 视图映射）
- 思路：将 3D 点 (X, Y, Z) 投影到 XY 平面得到 2D 点 (x, y)。

2) 选区
- 思路：用人工感知圈定建筑 ROI，形成 2D 多边形 P（顶点按顺序闭合）。
- 判定：逐点把原始 3D 点的 XY 投影 (x, y) 做“点在多边形内”测试。
- 结果：保留在 P 内的点，得到“建筑点云子集”；可将结果另存为 PLY 以便回溯与复用。


二、在 2D 上获取边界范围 + 分割四个面

这一部分的目标是：稳定得到建筑四个面的数据。推荐一个“简单稳健”的方案（也可替换为更精细的平面分割）。

1) 获取方向与方位（鲁棒 PCA）
- 目的：稳定估计“建筑主方向向量 u”和“垂直方向向量 v”，并给出朝向/方位角描述。
- 做法：
  - 对 XY 点集做中心化；为抑制离群点，先按到中心的半径排序并保留约 95% 的内点；
  - 计算 2×2 协方差矩阵，最大特征向量为主方向 u，正交向量为 v；
  - 统一象限方向并换算为真实方位角与指南针文字（用于命名“主/副方向 正/负面”）。

2) 凸包挤出 + 外法线比角分面（实际实现）
- 思路：在 XY 平面计算凸包并沿边等距采样，Z 方向分层“挤出”规则点；以边的外法线与 {±u, ±v} 的夹角最小原则进行立面归属。
- 做法与参数：
  - 计算 XY 凸包（ComputeConvexHull2D，单调链，顺时针返回以统一外法线方向）；
  - 沿凸包每条边按 `pointSpacing=8f` 等距采样，并以 `zSpacing=4f` 在 [z_min, z_max] 分层“挤出”生成规则点（GenerateFacadesByExtrudedHull）；
  - 对每条边取单位外法线 n，构造候选方向集合 D={+u, -u, +v, -v}，逐一计算角度 `angle(n,d)=arccos(clamp(dot(n,d),-1,1))`，选最小角对应的面作为该边采样点的归属（AssignEdgeSamplesToFacade）；
  - 输出各面规则点 FacadeState.GeneratedPoints，并据 u/v 更新面名与方位信息（UpdateFacadeAzimuthInfo）。
 - 说明：该方法几何上更贴近“外立面朝外”的直觉，较基于投影极值的阈值判定更鲁棒，尤其在外轮廓不规则时。


三、每面优化（指定距离）+ 蛇形排序 + 航点导出

1) 指定距离优化（采样/栅格化去冗余）
- 目标：控制点间距，减少冗余，使航线长度与拍摄重叠率更可控。
- 做法（任选其一或组合）：
  - 等距采样：在面内建立局部坐标 (沿线轴 a、竖直轴 z)，按 `Δa` 与 `Δz` 取样点；
  - 栅格化：将面投影到 (a, z)，以网格大小 `g≈指定距离` 聚类，每格选代表点（如最靠近格心或最高质量点）。

2) 蛇形排序（左→右，上一层→下一层）
- 思路：按高度自上而下分层；每层从左到右排序；相邻层反向，形成连续蛇形路径，减少折返。
- 做法：
  - 分层：以高度 z 降序，若相邻点的 |Δz| ≤ `epsilon` 视为同层；
  - 层内：根据“沿线轴 a”排序（左→右）；
  - 蛇形：第 0 层正序，第 1 层逆序，第 2 层正序……；
  - 合并：顺次拼接全部层的点，得到最终路径序列。

3) 航点导出（QGC WPL 110）
- 字段：`seq  current  frame  command  p1 p2 p3 p4  lat  lon  alt  autocontinue`。
- 映射建议：若仅用于仿真/可视，可按工程坐标映射 `lat=X, lon=Y, alt=Z`；若用于真机飞控，需做“工程坐标→地理坐标(WGS84)”的拟合与单位换算，或改用本地坐标系（LOCAL_NED）。
- 文件：每个面导出一个独立的 `.waypoints` 文件，便于独立执行与复核。


小结与建议
- 简化三步：2D 投影圈选 → PCA+OBB 获取边界并分面 → 指定距离优化 + 蛇形排序 + 导出航点；
- 关键参数：映射/投影、阈值 τ、层并入 `epsilon`、采样步长/网格大小、航点坐标框架；
- 若遇到非标准外形：用“凸包+外法线分面”增强鲁棒性，或在分面前进行地面/噪声清洗。


